<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- meta -->
    <meta
      name="description"
      content="Notary Hash is a simple web app that allows you to publish data to the blockchain. It uses the Bitcoin SV blockchain."
    />
    <meta
      name="keywords"
      content="Notary Hash, Notary, Hash, Bitcoin, Blockchain, Bitcoin SV, BSV, Publish, Data, Publish Data, Publish PDF, PDF, Publish PDF File, Publish File, File, Publish File, Hash Data, Hash, Sign Data, Sign, Verify Data, Verify, Verify Signature, Verify Hash, Verify Data, Verify Data on Blockchain, Verify Data on Bitcoin SV, Verify Data on BSV, Verify Data on Bitcoin, Verify Data on BTC, Verify Data on Bitcoin Cash, Verify Data on BCH, Verify Data on Bitcoin ABC, Verify Data on Bitcoin ABC, Verify Data on Bitcoin Cash ABC, Verify Data on BCHA, Verify Data on Bitcoin Cash Node, Verify Data on BCHN, Verify Data on Bitcoin Cash SV, Verify Data on BCSV, Verify Data on Bitcoin Cash Satoshi Vision, Verify Data on BSV, Verify Data on Bitcoin Satoshi Vision, Verify Data on Bitcoin SV"
    />
    <meta name="author" content="Notary Hash and SmartLedger" />
    <meta name="robots" content="index, follow" />
    <meta name="googlebot" content="index, follow" />
    <meta name="google" content="notranslate" />
    <title>Notary Hash</title>
    <script src="https://unpkg.com/bsv@1.5"></script>
    <script src="https://cdn.jsdelivr.net/npm/bsv@1.5.0/bsv-message.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bsv@1.5.0/bsv-mnemonic.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bsv@1.5.0/bsv-ecies.min.js"></script>
    <!-- qr creator -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
  </head>
  <style>
    body {
      font-family: "Roboto", sans-serif;
      background-color: #f4f4f4;
      color: #333;
      line-height: 1.6;
      margin: 0;
      padding: 0;
    }
    .mainContainer {
      max-width: 800px;
      margin: 20px auto;
      padding: 20px;
      background: white;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      word-wrap: break-word;
    }
    h1,
    h2 {
      color: #956134; /* Primary color for headers and links */
    }
    h1 {
      text-align: center;
      text-shadow: 0 1px 0 #333;
    }
    h2 {
      margin-top: 40px;
      text-shadow: 0 1px 0 #333;
    }
    form {
      display: flex;
      flex-direction: column;
      margin-bottom: 20px;
    }
    input,
    button {
      padding: 10px;
      margin-bottom: 10px;
      border-radius: 5px;
      border: 1px solid #ddd;
    }

    p {
      background-color: #e9ecef;
      padding: 10px;
      border-radius: 5px;
    }
    .result {
      word-break: break-all;
      display: none;
    }
    #keys {
      background-color: #e9ecef;
      padding: 10px;
      border-radius: 5px;
      word-wrap: break-word;
    }
    #keys p {
      margin: 0;
    }
    #logo {
      display: block;
      margin: 0 auto;
      width: 200px;
    }
    button {
      background-color: #956134; /* Primary color for buttons */
      color: white;
      border: none;
      cursor: pointer;
    }
    button:hover {
      background-color: #77471c; /* Primary color for buttons */
    }
    #logout {
      text-align: center;
    }
    #logoutButton {
      background-color: #956134; /* Primary color for buttons */
      color: white;
      border: none;
      cursor: pointer;
    }
    #qrGeneration {
      text-align: center;
      display: none;
    }
    #qrGeneration canvas {
      display: block;
      margin: 0 auto;
    }
    #qrGeneration a {
      display: block;
      margin: 0 auto;
      width: 200px;
      text-align: center;
    }
    #qrGeneration a:hover {
      background-color: #956134; /* Primary color for buttons */
      color: white;
    }
    @media (max-width: 600px) {
      .mainContainer {
        padding: 10px;
      }
      #logo {
        width: 100px;
      }
      #qrGeneration canvas {
        width: 100%;
      }
    }
  </style>
  <body>
    <div class="mainContainer">
      <img src="logo.png" alt="notaryhash" id="logo" />
      <h1>NotaryHash</h1>
      <div id="keys">
        <h2>Keys</h2>
        <p>
          <strong>Mnemonic:</strong>
          <span id="mnemonic"></span>
        </p>
        <p>
          <strong>Private Key:</strong>
          <span id="privateKey"></span>
        </p>
        <p>
          <strong>Public Key:</strong>
          <span id="publicKey"></span>
        </p>
        <p>
          <strong>Address:</strong>
          <span id="address"></span>
        </p>
        <p>
          <strong>Verified:</strong>
          <span id="verified"></span>
        </p>
      </div>
      <div id="qrGeneration">
        <h2>QR Code</h2>
        <canvas id="qr"></canvas>
      </div>
      <h2>Publish Data</h2>
      <form id="publishForm">
        <input type="text" name="data" placeholder="Enter data to publish" />
        <button type="submit">Publish</button>
      </form>
      <p class="result" id="publishResult"></p>

      <!-- publish pdf file -->
      <h2>Publish PDF File</h2>
      <form id="publishFileForm">
        <input type="file" name="file" placeholder="Enter data to publish" />
        <button type="submit">Publish</button>
      </form>
      <p class="result" id="publishFileResult"></p>

      <!-- Form for Hashing Data -->
      <h2>Hash Data</h2>
      <form id="hashForm">
        <input type="text" name="data" placeholder="Enter data to hash" />
        <button type="submit">Hash</button>
      </form>
      <p class="result" id="hashResult"></p>

      <!-- Form for Signing Data -->
      <h2>Sign Data</h2>
      <form id="signForm">
        <input type="text" name="data" placeholder="Enter data to sign" />
        <button type="submit">Sign</button>
      </form>
      <p class="result" id="signResult"></p>

      <!-- Form for Verifying Data -->
      <h2>Verify Data</h2>
      <form id="verifyForm">
        <input type="text" name="data" placeholder="Enter data" />
        <input type="text" name="sig" placeholder="Enter signature" />
        <input type="text" name="address" placeholder="Enter address" />
        <button type="submit">Verify</button>
      </form>
      <p class="result" id="verifyResult"></p>
      <!-- logout -->
      <div id="logout">
        <button id="logoutButton">Logout</button>
      </div>
      <!-- copyright 2024 NotaryHash and SmartLedger -->
      <p>&copy; 2024 NotaryHash and SmartLedger. All rights reserved.</p>
    </div>
    <script src="encryption.js"></script>
    <script>
      const Buffer = bsv.deps.Buffer;
      const generateKeys = () => {
        if (address && !confirm("Generate new keys?")) {
          return;
        }
        const Mnemonic = bsv.Mnemonic;
        const mnemonic = new Mnemonic();
        const fullPath = "m/44'/0'/0'/0/0";
        const xpriv = mnemonic.toHDPrivateKey(); // HD Private Key
        const derivedPriv = xpriv.deriveChild(fullPath); // Derive the private key using the full path
        const priv = derivedPriv.privateKey; // Get the actual private key
        const pub = bsv.PublicKey.fromPrivateKey(priv); // Derive the public key from the private key
        address = bsv.Address.fromPublicKey(pub).toString();
        const jsonString = JSON.stringify({
          address: address,
          privateKey: priv.toString(),
          publicKey: pub.toString(),
          mnemonic: mnemonic.toString(),
          path: fullPath,
        });
        return jsonString;
      };
      const encrypt = (myString, myPassword) => {
        //crypto-js
        const cryptoJS = window.CryptoJS;
        // Encrypt
        const ciphertext = cryptoJS.AES.encrypt(
          myString,
          myPassword
        ).toString();
        return ciphertext;
      };
      //
      const decrypt = (myString, myPassword) => {
        //crypto-js
        const cryptoJS = window.CryptoJS;
        // Decrypt
        const bytes = cryptoJS.AES.decrypt(myString, myPassword);
        const plaintext = bytes.toString(cryptoJS.enc.Utf8);
        return plaintext;
      };

      //display qr code high resolution
      const displayQRCode = (data) => {
        //clear qr code
        const qr = new QRious({
          element: document.getElementById("qr"),
          value: data,
          size: 200,
        });
        document.getElementById("qrGeneration").style.display = "block";
      };

      const hashData = (data) => {
        // Return the hash as a Buffer
        return bsv.crypto.Hash.sha256(Buffer.from(data));
      };

      const signData = (data) => {
        const privateKey = bsv.PrivateKey.fromWIF(
          localStorage.getItem("privateKey")
        );

        // Use the hash buffer directly
        const hashBuffer = hashData(data);
        const signature = bsv.crypto.ECDSA.sign(hashBuffer, privateKey);

        return signature.toString();
      };
      const verifyData = (data, sig, address) => {
        const publicKey = new bsv.PublicKey(address);
        const signature = new bsv.crypto.Signature(sig);
        return bsv.crypto.ECDSA.verify(
          Buffer.from(hashData(data)),
          signature,
          publicKey
        );
      };
      if (
        !localStorage.getItem("registered") ||
        localStorage.getItem("registered") === "false" ||
        !localStorage.getItem("publicKey") ||
        !localStorage.getItem("date")
      ) {
        location.href = "/";
      }
      if (localStorage.getItem("registered") === "true") {
        document.getElementById("verified").innerHTML = "Yes";
      } else {
        document.getElementById(
          "verified"
        ).innerHTML = `No. Please visit <a href="https://notaryhash.com/register" target="_blank">Notary Hash Register Page</a> to register your address.`;
      }
      document.getElementById("publicKey").innerHTML =
        localStorage.getItem("publicKey");
      document.getElementById("address").innerHTML =
        localStorage.getItem("address");
      document.getElementById("privateKey").innerHTML = `**********`;
      let private = false;
      document.getElementById("mnemonic").innerHTML = `**********`;
      document
        .getElementById("privateKey")
        .addEventListener("click", function (e) {
          e.preventDefault();
          if (private) {
            this.innerHTML = `**********`;
            private = false;
          } else {
            this.innerHTML = localStorage.getItem("privateKey");
            private = true;
          }
        });
      document
        .getElementById("mnemonic")
        .addEventListener("click", function (e) {
          e.preventDefault();
          if (private) {
            this.innerHTML = `**********`;
            private = false;
          } else {
            this.innerHTML = localStorage.getItem("mnemonic");
            private = true;
          }
        });

      document
        .getElementById("publishForm")
        .addEventListener("submit", function (e) {
          e.preventDefault();
          const hash = hashData(this.data.value);
          const signature = signData(this.data.value);
          console.log(hash.toString("hex"));
          console.log(signature);
          sendData(
            "/publish",
            {
              token: localStorage.getItem("token"),
              data: this.data.value,
              hash: hash.toString("hex"),
              signature: signature,
              publicKey: localStorage.getItem("publicKey"),
              address: localStorage.getItem("address"),
            },
            "publishResult",
            true
          );
        });

      document
        .getElementById("hashForm")
        .addEventListener("submit", function (e) {
          e.preventDefault();
          const hash = hashData(this.data.value);
          const signature = signData(this.data.value);
          console.log(hash.toString("hex"));
          console.log(signature);
          sendData(
            "/hash",
            {
              token: localStorage.getItem("token"),
              data: this.data.value,
              hash: hash.toString("hex"),
              signature: signature,
              publicKey: localStorage.getItem("publicKey"),
              address: localStorage.getItem("address"),
            },
            "hashResult",
            true
          );
        });

      document
        .getElementById("signForm")
        .addEventListener("submit", function (e) {
          e.preventDefault();
          const hash = hashData(this.data.value);
          const signature = signData(this.data.value);
          console.log(hash.toString("hex"));
          console.log(signature);
          sendData(
            "/sign",
            {
              token: localStorage.getItem("token"),
              data: this.data.value,
              hash: hash.toString("hex"),
              signature: signature,
              publicKey: localStorage.getItem("publicKey"),
              address: localStorage.getItem("address"),
            },
            "signResult",
            true
          );
        });

      document
        .getElementById("verifyForm")
        .addEventListener("submit", function (e) {
          e.preventDefault();
          sendData(
            "/verify",
            {
              data: this.data.value,
              sig: this.sig.value,
              address: this.address.value,
            },
            "verifyResult"
          );
        });

      document
        .getElementById("publishFileForm")
        .addEventListener("submit", function (e) {
          e.preventDefault();
          const file = this.file.files[0];
          const mimeType = file.type;
          const reader = new FileReader();
          reader.readAsDataURL(file);
          reader.onload = () => {
            const hash = hashData(reader.result);
            const signature = signData(reader.result);
            console.log(hash.toString("hex"));
            console.log(signature);
            sendData(
              "/publishFile",
              {
                token: localStorage.getItem("token"),
                data: reader.result.split(",")[1], // remove "data:application/pdf;base64," from the data url [1
                mimeType: mimeType,
                hash: hash.toString("hex"),
                signature: signature,
                publicKey: localStorage.getItem("publicKey"),
                address: localStorage.getItem("address"),
              },
              "publishFileResult",
              true
            );
          };
        });

      function sendData(url, data, resultElementId, txStatus) {
        fetch(url, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(data),
        })
          .then((response) => response.text())
          .then((data) => {
            document.getElementById(resultElementId).innerHTML = "";
            document.getElementById(resultElementId).innerHTML = txStatus
              ? `<a href="https://whatsonchain.com/tx/${data}" target="_blank">${data}</a>`
              : data;
            document.getElementById(resultElementId).style.display = "block";
            // display qr code
            displayQRCode(
              `https://plugins.whatsonchain.com/api/plugin/main/${data}`
            );
            // add download link for qr code png
            const qr = document.getElementById("qr");
            //remove previous download link
            const qrPng = qr.toDataURL("image/png");
            const qrPngLink = document.createElement("a");
            qrPngLink.href = qrPng;
            qrPngLink.download = "qr.png";
            qrPngLink.innerHTML = `Download QR Code https://plugins.whatsonchain.com/api/plugin/main/${data}`;
            document.getElementById("qrGeneration").appendChild(qrPngLink);
          })
          .catch((error) => {
            console.error("Error:", error);
          });
      }
      const getUtxos = (address) => {
        return fetch(
          `https://api.whatsonchain.com/v1/bsv/main/address/${address}/unspent`
        )
          .then((response) => response.json())
          .then((data) => {
            return data.map((utxo) => {
              return {
                txId: utxo.tx_hash,
                outputIndex: utxo.tx_pos,
                satoshis: utxo.value,
                script: bsv.Script.buildPublicKeyHashOut(address).toHex(),
              };
            });
          });
      };
      const broadcastTx = (tx) => {
        return fetch("https://api.whatsonchain.com/v1/bsv/main/tx/raw", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ txhex: tx.toString() }),
        })
          .then((response) => response.json())
          .then((data) => {
            return data;
          });
      };

      const sendFunds = async (receiver, amount) => {
        const address = localStorage.getItem("address");
        const utxos = await getUtxos(address);
        const privateKey = bsv.PrivateKey.fromWIF(
          localStorage.getItem("privateKey")
        );
        const tx = new bsv.Transaction()
          .from(utxos)
          .to(receiver, amount)
          .change(address)
          .sign(privateKey);
        console.log(tx.toString());
        document.getElementById(
          "publishResult"
        ).innerHTML = `<a href="https://whatsonchain.com/tx/${tx.id}" target="_blank">${tx.id}</a>`;
        document.getElementById("publishResult").style.display = "block";
        const txId = await broadcastTx(tx);
        console.log(txId);
      };

      //   sendFunds("1AGFr8YeV4AmCVQrkfZYfHw77KrK6XNfVK", 100000);

      document
        .getElementById("logoutButton")
        .addEventListener("click", function (e) {
          e.preventDefault();
          localStorage.clear();
          window.location.href = "/";
        });

      //check localStorage.date and token
      if (localStorage.getItem("date") && localStorage.getItem("token")) {
        //check if date is more than 24 hours
        const date = new Date(localStorage.getItem("date"));
        const now = new Date();
        const diff = now - date;
        const hours = Math.floor(diff / 1000 / 60 / 60);
        if (hours > 1) {
          //logout
          localStorage.clear();
          window.location.href = "/";
        }
      } else {
        //logout
        localStorage.clear();
        window.location.href = "/";
      }
    </script>
  </body>
</html>
