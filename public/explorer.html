<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Transaction Explorer</title>
    <script src="https://unpkg.com/bsv@1.5"></script>
    <script src="https://cdn.jsdelivr.net/npm/bsv@1.5.0/bsv-message.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bsv@1.5.0/bsv-mnemonic.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bsv@1.5.0/bsv-ecies.min.js"></script>
    <!-- qr scanner -->
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.8/html5-qrcode.min.js"
      integrity="sha512-r6rDA7W6ZeQhvl8S7yRVQUKVHdexq+GAlNkNNqVC7YyIV+NwqCTJe2hDWCiffTyRNOeGEzRRJ9ifvRm/HCzGYg=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    ></script>
    <style>
      /* Existing styles */
      .scanner-controls {
        text-align: center;
      }
      .scanner-message {
        color: green;
        margin: 5px 0;
      }
      #scanner {
        width: 100%;
        height: 100%;
      }
    </style>
  </head>
  <body>
    <div class="main">
      <!-- Existing body content -->
      <div class="scanner-controls">
        <button id="start-scan">Start Scan</button>
        <button id="stop-scan" disabled>Stop Scan</button>
        <p class="scanner-message" id="scanner-message"></p>
      </div>
      <div id="scanner"></div>
    </div>
    <script>
      function getTxInfo(txid) {
        return fetch("https://api.whatsonchain.com/v1/bsv/main/tx/hash/" + txid)
          .then((response) => response.json())
          .then((data) => {
            return data;
          });
      }
      //   display txinfo
      function displayTxInfo(txinfo) {
        document.getElementById("txinfo").innerHTML = JSON.stringify(
          txinfo,
          null,
          2
        );
      }
      //   check for op_return
      function checkOpReturn(txinfo) {
        if (txinfo.vout[0].scriptPubKey.type === "nulldata") {
          return true;
        } else {
          return false;
        }
      }
      //display op_return
      function displayOpReturn(txinfo) {
        document.getElementById("opreturn").innerHTML =
          txinfo.vout[0].scriptPubKey.asm;
      }
      let html5QrCode;
      function initQRScanner() {
        html5QrCode = new Html5Qrcode("scanner");
        document
          .getElementById("start-scan")
          .addEventListener("click", function () {
            scanQRCode();
            this.disabled = true;
            document.getElementById("stop-scan").disabled = false;
          });
        document
          .getElementById("stop-scan")
          .addEventListener("click", function () {
            if (html5QrCode) {
              html5QrCode
                .stop()
                .then(() => {
                  console.log("QR Scanning stopped.");
                  document.getElementById("scanner-message").innerText = "";
                })
                .catch((err) => {
                  console.error("Unable to stop scanning.", err);
                });
            }
            this.disabled = true;
            document.getElementById("start-san").disabled = false;
          });
      }

      function scanQRCode() {
        html5QrCode.start(
          { facingMode: "environment" },
          { fps: 10, qrbox: 250 },
          (qrCodeMessage) => {
            //if not includes https the return
            if (!qrCodeMessage.includes("https")) {
              document.getElementById("scanner-message").innerText =
                "Invalid QR Code.";
              return;
            }
            document.getElementById("txid").value = qrCodeMessage;
            document.getElementById("load").click();
            html5QrCode.stop();
            document.getElementById("scanner-message").innerText =
              "QR Code scanned successfully!";
          },
          (errorMessage) => {
            console.error(errorMessage);
            document.getElementById("scanner-message").innerText =
              "Error scanning QR Code.";
          }
        );
      }

      window.onload = initQRScanner;
    </script>
  </body>
</html>
