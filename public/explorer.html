<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="shortcut icon" href="logo.png" type="image/x-icon" />
    <!-- meta title -->
    <meta name="title" content="NotaryHash" />
    <!-- meta description -->
    <meta
      name="description"
      content="Welcome to our Notary Hash, your gateway to harnessing the full
        potential of blockchain technology. Our app offers a comprehensive suite
        of tools designed to interact seamlessly with the blockchain. Experience
        the power of hashing, encryption, digital signing, and publishing of
        data, along with robust verification capabilities for future reference.
        Our services are pivotal across a broad spectrum of applications,
        including legal notarization, data timestamping for file integrity, and
        precision agriculture. We also cater to specialized needs in supply
        chain management, evidence control, pharmaceutical research, and
        ensuring the safety in the cannabis industry. Step into the future of
        secure, transparent, and efficient data handling with our blockchain
        solution."
    />
    <!-- meta keywords -->
    <meta
      name="keywords"
      content="blockchain, notary, hash, notaryhash, bsv, bitcoin, bitcoin sv, bsv blockchain, blockchain notary, blockchain hash, blockchain notaryhash, notaryhash bsv, notaryhash bitcoin, notaryhash bitcoin sv, notaryhash bsv blockchain, notaryhash blockchain, notaryhash blockchain notary, notaryhash blockchain hash, notaryhash blockchain notaryhash, notaryhash notaryhash, notaryhash notary, notaryhash hash, notaryhash notaryhash bsv, notaryhash notaryhash bitcoin, notaryhash notaryhash bitcoin sv, notaryhash notaryhash bsv blockchain, notaryhash notaryhash blockchain, notaryhash notaryhash blockchain notary, notaryhash notaryhash blockchain hash, notaryhash notaryhash blockchain notaryhash, notaryhash notaryhash notaryhash, notaryhash notaryhash notary, notaryhash notaryhash hash, notaryhash notaryhash notaryhash bsv, notaryhash notaryhash notaryhash bitcoin, notaryhash notaryhash notaryhash bitcoin sv, notaryhash notaryhash notaryhash bsv blockchain, notaryhash notaryhash notaryhash blockchain, notaryhash notaryhash notaryhash blockchain notary, notaryhash notaryhash notaryhash blockchain hash, notaryhash notaryhash notaryhash blockchain notaryhash"
    />
    <!-- meta author -->
    <meta name="author" content="NotaryHash" />
    <!-- meta og:title -->
    <meta property="og:title" content="NotaryHash" />
    <!-- meta og:description -->
    <meta
      property="og:description"
      content="Welcome to our Notary Hash, your gateway to harnessing the full
        potential of blockchain technology. Our app offers a comprehensive suite
        of tools designed to interact seamlessly with the blockchain. Experience
        the power of hashing, encryption, digital signing, and publishing of
        data, along with robust verification capabilities for future reference.
        Our services are pivotal across a broad spectrum of applications,
        including legal notarization, data timestamping for file integrity, and
        precision agriculture. We also cater to specialized needs in supply
        chain management, evidence control, pharmaceutical research, and
        ensuring the safety in the cannabis industry. Step into the future of
        secure, transparent, and efficient data handling with our blockchain
        solution."
    />
    <!-- meta og:image -->
    <meta property="og:image" content="logo.png" />
    <!-- meta og:url -->
    <meta property="og:url" content="https://notaryhash.com" />
    <!-- meta twitter:title -->
    <meta property="twitter:title" content="NotaryHash" />
    <!-- meta twitter:description -->
    <meta
      property="twitter:description"
      content="Welcome to our Notary Hash, your gateway to harnessing the full
        potential of blockchain technology. Our app offers a comprehensive suite
        of tools designed to interact seamlessly with the blockchain. Experience
        the power of hashing, encryption, digital signing, and publishing of
        data, along with robust verification capabilities for future reference.
        Our services are pivotal across a broad spectrum of applications,
        including legal notarization, data timestamping for file integrity, and
        precision agriculture. We also cater to specialized needs in supply
        chain management, evidence control, pharmaceutical research, and
        ensuring the safety in the cannabis industry. Step into the future of
        secure, transparent, and efficient data handling with our blockchain
        solution."
    />
    <!-- meta twitter:image -->
    <meta property="twitter:image" content="logo.png" />
    <!-- meta twitter:card -->
    <meta property="twitter:card" content="summary_large_image" />
    <!-- meta twitter:creator -->
    <meta property="twitter:creator" content="@notaryhash" />
    <!-- meta twitter:site -->
    <meta property="twitter:site" content="@notaryhash" />
    <!-- meta twitter:domain -->
    <meta property="twitter:domain" content="notaryhash.com" />
    <!-- meta twitter:url -->
    <meta property="twitter:url" content="https://notaryhash.com" />
    <!-- meta twitter:label1 -->
    <meta property="twitter:label1" content="Written by" />
    <title>Notary Hash Transaction Explorer</title>
    <script src="https://unpkg.com/bsv@1.5"></script>
    <script src="https://cdn.jsdelivr.net/npm/bsv@1.5.0/bsv-message.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bsv@1.5.0/bsv-mnemonic.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bsv@1.5.0/bsv-ecies.min.js"></script>
    <!-- qr scanner -->
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.8/html5-qrcode.min.js"
      integrity="sha512-r6rDA7W6ZeQhvl8S7yRVQUKVHdexq+GAlNkNNqVC7YyIV+NwqCTJe2hDWCiffTyRNOeGEzRRJ9ifvRm/HCzGYg=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    ></script>
    <style>
      * {
        box-sizing: border-box;
      }
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        margin: 0;
        padding: 0;
        background-color: #f5f5f5;
      }
      .main {
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
      }
      #logo {
        width: 100px;
        height: 100px;
        display: block;
        margin: 0 auto;
      }
      h1 {
        text-align: center;
        font-size: 2rem;
        margin: 0;
        padding: 0;
      }
      h2 {
        text-align: center;
        font-size: 1.5rem;
        margin: 0;
        padding: 0;
      }
      p {
        margin: 0;
        padding: 0;
      }
      label {
        display: block;
        margin-bottom: 5px;
      }
      input[type="text"] {
        width: 100%;
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 5px;
        margin-bottom: 10px;
      }
      button {
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 5px;
        background-color: #fff;
        cursor: pointer;
      }
      button:hover {
        background-color: #ccc;
      }

      #outputImage {
        width: 100%;
        display: block;
        margin: 0 auto;
      }
      .scanner-controls {
        text-align: center;
      }
      #scanner-message {
        margin: 0;
        padding: 0;
      }
      #scanner {
        width: 100%;
        height: 100%;
        display: block;
        margin: 0 auto;
      }
      #opreturn {
        margin: 0;
        padding: 0;
      }

      @media (max-width: 768px) {
        .main {
          padding: 10px;
        }
        #logo {
          width: 50px;
          height: 50px;
        }
        h1 {
          font-size: 1.5rem;
        }
        h2 {
          font-size: 1.2rem;
        }
      }
    </style>
  </head>
  <body>
    <div class="main">
      <img src="logo.png" alt="NotaryHash Logo" id="logo" />
      <h1>NotaryHash</h1>
      <h2>Transaction Explorer</h2>
      <p>
        <label for="txid">Transaction ID</label>
        <input type="text" id="txid" />
        <button id="load">Load</button>
      </p>
      <p id="txinfo"></p>
      <p id="opreturn"></p>
      <img id="outputImage" />
      <div id="opreturn"></div>
      <div class="scanner-controls">
        <button id="start-scan">Start Scan</button>
        <button id="stop-scan" disabled>Stop Scan</button>
        <p class="scanner-message" id="scanner-message"></p>
      </div>
      <div id="scanner"></div>
    </div>
    <script>
      //check for op_return and return op_return if true
      const Buffer = bsv.deps.Buffer;
      const verifyData = (data, sig, publicKeyString) => {
        try {
          //der format public key
          const publicKey = bsv.PublicKey.fromHex(publicKeyString);
          // Use the hash buffer directly
          const hashBuffer = bsv.crypto.Hash.sha256(Buffer.from(data));
          const signature = bsv.crypto.Signature.fromString(sig);
          const verified = bsv.crypto.ECDSA.verify(
            hashBuffer,
            signature,
            publicKey
          );
          return verified;
        } catch (error) {
          console.error("Error in verifyData:", error.message);
          return false;
        }
      };
      function getTxInfo(txid) {
        return fetch(`https://api.whatsonchain.com/v1/bsv/main/tx/${txid}/hex`)
          .then((response) => response.text())
          .then((data) => {
            //add hex to bsv.Transaction
            const tx = new bsv.Transaction(data);
            return tx;
          });
      }

      //convert hex to ascii
      function hex2a(hex) {
        // var hex = hexx.toString(); //force conversion
        var str = "";
        for (var i = 0; i < hex.length && hex.substr(i, 2) !== "00"; i += 2)
          str += String.fromCharCode(parseInt(hex.substr(i, 2), 16));
        return str;
      }
      //display op_return
      function displayOpReturn(txinfo) {
        let op_return = txinfo.outputs[0].script.toASM();
        const op_return_split = op_return.split(" ");
        //remove first element
        op_return_split.shift();
        console.log(op_return_split);
        let element = "";
        let aipCheck = false;
        let verified = false;
        let verifiedEl = document.createElement("p");
        if (op_return_split[0] == "OP_RETURN") {
          let appId_hex = op_return_split[1];
          let appId_ascii = hex2a(appId_hex);
          let op_return_hex = op_return_split[2];
          const op_return_buffer = Buffer.from(op_return_hex, "hex");
          const base64 = op_return_buffer.toString("base64");
          let mimeType_hex = op_return_split[3];
          let mimeType_ascii = hex2a(mimeType_hex);
          console.log(appId_ascii, mimeType_ascii, op_return_hex);
          //create element based on mimeType

          if (op_return_split[11] && hex2a(op_return_split[11]) == "AIP") {
            console.log("AIP");
            aipCheck = true;
            const pubKeyString = op_return_split[13];
            const publicKey = hex2a(pubKeyString);
            console.log(publicKey);
            const sign = op_return_split[14];
            const signature = hex2a(sign);
            const message = hex2a(op_return_split[2]);
            console.log(message, signature, publicKey);
            const verified = verifyData(message, signature, publicKey);
            if (verified) {
              console.log("Signature verified");
              //display verified
              verifiedEl.innerHTML = `Signature verified by ${publicKey}`;
              verifiedEl.style.color = "green";
              verifiedEl.style.fontWeight = "bold";
              //padding 10px
              verifiedEl.style.padding = "10px";
              document.getElementById("opreturn").appendChild(verifiedEl);
            } else {
              console.log("Signature verification failed");
              //display not verified
              verifiedEl.innerHTML = `Signature verification failed by ${publicKey}`;
              verifiedEl.style.color = "red";
              verifiedEl.style.fontWeight = "bold";
              //padding 10px
              verifiedEl.style.padding = "10px";

              document.getElementById("opreturn").appendChild(verifiedEl);
            }
          }

          if (mimeType_ascii == "text/plain") {
            element = document.createElement("p");
            element.innerText = hex2a(op_return_hex);
          } else if (mimeType_ascii == "image/png") {
            element = document.createElement("img");
            element.setAttribute("src", "data:image/png;base64," + base64);
          } else if (mimeType_ascii == "image/jpeg") {
            element = document.createElement("img");
            element.setAttribute("src", "data:image/jpeg;base64," + base64);
          } else if (mimeType_ascii == "image/gif") {
            element = document.createElement("img");
            element.setAttribute("src", "data:image/gif;base64," + base64);
          } else if (mimeType_ascii == "application/pdf") {
            element = document.createElement("embed");
            element.setAttribute(
              "src",
              "data:application/pdf;base64," + base64
            );
          } else if (mimeType_ascii == "application/json") {
            element = document.createElement("p");
            element.innerText = hex2a(op_return_hex);
          } //video/mp4
          else if (mimeType_ascii == "video/mp4") {
            element = document.createElement("video");
            element.setAttribute("controls", "controls");
            element.setAttribute("src", "data:video/mp4;base64," + base64);
          } //audio
          else if (mimeType_ascii == "audio/mpeg") {
            element = document.createElement("audio");
            element.setAttribute("controls", "controls");
            element.setAttribute("src", "data:audio/mpeg;base64," + base64);
          } else {
            element = document.createElement("p");
            element.innerText = hex2a(op_return_hex);
          }
          element.style.border = "1px solid #ccc";
          //width 100%
          element.style.width = "100%";
          //display block
          element.style.display = "block";
          //margin 0 auto
          element.style.margin = "0 auto";
          //padding 10px
          element.style.padding = "10px";
          //height 70vh
          element.style.height = "70vh";
          document.getElementById("opreturn").appendChild(element);
        }
      }

      function hexToBinary(hexString) {
        const byteArray = new Uint8Array(hexString.length / 2);
        for (let i = 0; i < hexString.length; i += 2) {
          byteArray[i / 2] = parseInt(hexString.substring(i, i + 2), 16);
        }
        return byteArray;
      }

      function hexToString(hexString) {
        var string = "";
        for (var i = 0; i < hexString.length; i += 2) {
          string += String.fromCharCode(
            parseInt(hexString.substring(i, i + 2), 16)
          );
        }
        return string;
      }
      let found = false;
      let html5QrCode;
      function initQRScanner() {
        html5QrCode = new Html5Qrcode("scanner");
        document
          .getElementById("start-scan")
          .addEventListener("click", function () {
            found = false;
            // close the previous instance of Html5QrcodeScanner
            document.getElementById("opreturn").innerHTML = "";
            document.getElementById("scanner-message").innerText =
              "Scanning...";
            scanQRCode();
            this.disabled = true;
            document.getElementById("stop-scan").disabled = false;
          });
        document
          .getElementById("stop-scan")
          .addEventListener("click", function () {
            if (html5QrCode) {
              html5QrCode
                .stop()
                .then(() => {
                  found = false;
                  console.log("QR Scanning stopped.");
                  document.getElementById("scanner-message").innerText = "";
                })
                .catch((err) => {
                  console.error("Unable to stop scanning.", err);
                });
            }
            this.disabled = true;
            document.getElementById("start-san").disabled = false;
          });
      }
      function scanQRCode() {
        html5QrCode.start(
          { facingMode: "environment" },
          { fps: 10, qrbox: 250 },
          (qrCodeMessage) => {
            if (found) {
              return;
            }
            //if not includes https the return
            if (qrCodeMessage.includes("https")) {
              let txid = qrCodeMessage.split("/").pop();
              if (txid.length == 64) {
                getTxInfo(txid).then((txinfo) => {
                  displayOpReturn(txinfo);
                });
                found = true;
              }
            }
          },
          (errorMessage) => {
            // parse error, ignore it.
          }
        );
      }

      window.onload = initQRScanner;

      document.getElementById("load").addEventListener("click", function () {
        let txid = document.getElementById("txid").value;
        document.getElementById("opreturn").innerHTML = "";
        getTxInfo(txid).then((txinfo) => {
          displayOpReturn(txinfo);
        });
      });

      //url params
      const queryString = window.location.search;
      const urlParams = new URLSearchParams(queryString);
      const txid = urlParams.get("txid");
      if (txid) {
        document.getElementById("txid").value = txid;
        document.getElementById("load").click();
      }
    </script>
  </body>
</html>
