<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Blockchain Data Manager</title>
    <!-- bsv@1.5 cdn unpkg -->
    <script src="https://unpkg.com/bsv@1.5"></script>
  </head>
  <style>
    body {
      font-family: sans-serif;
    }
    input {
      width: 100%;
      padding: 0.5rem;
      margin-bottom: 1rem;
    }
    button {
      padding: 0.5rem;
      margin-bottom: 1rem;
    }
    h1 {
      text-align: center;
    }
    h2 {
      margin-top: 2rem;
    }

    #publishForm,
    #hashForm,
    #signForm,
    #verifyForm {
      max-width: 500px;
      margin: 0 auto;
    }

    #publishResult,
    #hashResult,
    #signResult,
    #verifyResult {
      max-width: 500px;
      margin: 0 auto;
      padding: 1rem;
      border: 1px solid #ccc;
      background-color: #eee;
    }
  </style>
  <body>
    <h1>Blockchain Data Manager</h1>

    <!-- Form for Publishing Data -->
    <h2>Publish Data</h2>
    <form id="publishForm">
      <input type="text" name="data" placeholder="Enter data to publish" />
      <button type="submit">Publish</button>
    </form>
    <p id="publishResult"></p>

    <!-- Form for Hashing Data -->
    <h2>Hash Data</h2>
    <form id="hashForm">
      <input type="text" name="data" placeholder="Enter data to hash" />
      <button type="submit">Hash</button>
    </form>
    <p id="hashResult"></p>

    <!-- Form for Signing Data -->
    <h2>Sign Data</h2>
    <form id="signForm">
      <input type="text" name="data" placeholder="Enter data to sign" />
      <button type="submit">Sign</button>
    </form>
    <p id="signResult"></p>

    <!-- Form for Verifying Data -->
    <h2>Verify Data</h2>
    <form id="verifyForm">
      <input type="text" name="data" placeholder="Enter data" />
      <input type="text" name="sig" placeholder="Enter signature" />
      <input type="text" name="address" placeholder="Enter address" />
      <button type="submit">Verify</button>
    </form>
    <p id="verifyResult"></p>

    <script>
      const Buffer = bsv.deps.Buffer;
      const hashData = (data) => {
        // Return the hash as a Buffer
        return bsv.crypto.Hash.sha256(Buffer.from(data));
      };

      const signData = (data) => {
        const privateKey = bsv.PrivateKey.fromWIF(
          localStorage.getItem("privateKey")
        );

        // Use the hash buffer directly
        const hashBuffer = hashData(data);
        const signature = bsv.crypto.ECDSA.sign(hashBuffer, privateKey);

        return signature.toString();
      };
      const verifyData = (data, sig, address) => {
        const publicKey = new bsv.PublicKey(address);
        const signature = new bsv.crypto.Signature(sig);
        return bsv.crypto.ECDSA.verify(
          Buffer.from(hashData(data)),
          signature,
          publicKey
        );
      };
      //if not keys in local storage, create them
      if (!localStorage.getItem("privateKey")) {
        const privateKey = new bsv.PrivateKey();
        localStorage.setItem("privateKey", privateKey.toString());
        localStorage.setItem("publicKey", privateKey.toPublicKey().toString());
        localStorage.setItem("address", privateKey.toAddress().toString());
      }
      document
        .getElementById("publishForm")
        .addEventListener("submit", function (e) {
          e.preventDefault();
          const hash = hashData(this.data.value);
          const signature = signData(this.data.value);
          console.log(hash.toString("hex"));
          console.log(signature);
          sendData(
            "/publish",
            {
              data: this.data.value,
              hash: hash,
              signature: signature,
              publicKey: localStorage.getItem("publicKey"),
              address: localStorage.getItem("address"),
            },
            "publishResult"
          );
        });

      document
        .getElementById("hashForm")
        .addEventListener("submit", function (e) {
          e.preventDefault();
          sendData("/hash", { data: this.data.value }, "hashResult");
        });

      document
        .getElementById("signForm")
        .addEventListener("submit", function (e) {
          e.preventDefault();
          sendData("/sign", { data: this.data.value }, "signResult");
        });

      document
        .getElementById("verifyForm")
        .addEventListener("submit", function (e) {
          e.preventDefault();
          sendData(
            "/verify",
            {
              data: this.data.value,
              sig: this.sig.value,
              address: this.address.value,
            },
            "verifyResult"
          );
        });

      function sendData(url, data, resultElementId) {
        fetch(url, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(data),
        })
          .then((response) => response.text())
          .then((data) => {
            document.getElementById(resultElementId).textContent = data;
          })
          .catch((error) => {
            console.error("Error:", error);
          });
      }
    </script>
  </body>
</html>
