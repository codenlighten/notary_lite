<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Registration</title>
    <script src="https://unpkg.com/bsv@1.5"></script>
    <script src="https://cdn.jsdelivr.net/npm/bsv@1.5.0/bsv-message.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bsv@1.5.0/bsv-mnemonic.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bsv@1.5.0/bsv-ecies.min.js"></script>
  </head>
  <style>
    body {
      font-family: "Roboto", sans-serif;
      background-color: #f4f4f4;
      color: #333;
      line-height: 1.6;
      margin: 0;
      padding: 0;
    }
    .mainContainer {
      max-width: 800px;
      margin: 20px auto;
      padding: 20px;
      background: white;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    }
    h1,
    h2 {
      color: #956134; /* Primary color for headers and links */
    }
    h1 {
      text-align: center;
      text-shadow: 0 1px 0 #333;
    }
    h2 {
      margin-top: 40px;
      text-shadow: 0 1px 0 #333;
    }
    form {
      display: flex;
      flex-direction: column;
      margin-bottom: 20px;
    }
    input,
    button {
      padding: 10px;
      margin-bottom: 10px;
      border-radius: 5px;
      border: 1px solid #ddd;
    }
    button {
      background-color: #956134; /* Primary color for buttons */
      color: white;
      border: none;
      cursor: pointer;
    }
    button:hover {
      background-color: #77471c; /* Slightly darker shade for hover effect */
    }
    p {
      background-color: #e9ecef;
      padding: 10px;
      border-radius: 5px;
    }
    .result {
      word-break: break-all;
      display: none;
    }
    #logo {
      display: block;
      margin: 0 auto;
      width: 300px;
    }
    .forms {
      display: none;
    }
    #buttonChoices {
      display: flex;
      flex-direction: row;
      justify-content: center;
    }
    #buttonChoices button {
      margin: 0 10px;
      width: 100px;
    }
    #message {
      display: none;
      background-color: #e9ecef;
      padding: 10px;
      border-radius: 5px;
      margin-top: 20px;
    }
    #message a {
      color: #956134;
    }
    #message a:hover {
      color: #77471c;
    }
    #message p {
      margin: 0;
    }
    #logout {
      display: none;
      margin-top: 20px;
      text-align: center;
    }
    #logoutButton {
      background-color: #956134;
      color: white;
      border: none;
      cursor: pointer;
      padding: 10px;
      border-radius: 5px;
    }

    @media (max-width: 600px) {
      .mainContainer {
        padding: 10px;
      }
      #logo {
        width: 200px;
      }
      #buttonChoices {
        flex-direction: column;
      }
      #buttonChoices button {
        margin: 10px 0;
        width: 100%;
      }
    }
  </style>
  <body>
    <div class="mainContainer">
      <img src="logo.png" alt="NotaryHash Logo" id="logo" />
      <h1>NotaryHash</h1>
      <p>
        Notary Hash allows you to interact with the blockchain to publish data,
        hash data, sign data, and verify it in the future. Legal notaries, data
        timestamping, file integrity, precision agriculture, supply chain,
        evidence controls, pharmaceutical research, cannabis safety and more.
      </p>
      <p class="result" id="resultTxid"></p>
      <p class="result" id="message"></p>
      <div id="buttonChoices">
        <button id="showRegistration">Register</button>
        <button id="showLogin">Login</button>
      </div>
      <div class="forms" id="registration">
        <h2>Register ID</h2>
        <form id="publishForm">
          <input type="text" name="data" placeholder="First Name" />
          <input type="text" name="data" placeholder="Last Name" />
          <input type="date" name="data" placeholder="Birthdate" />
          <input type="text" name="data" placeholder="Country" />
          <!-- email -->
          <input placeholder="email address" type="email" id="emailRegister" />
          <input type="password" name="data" placeholder="Password" />
          <input type="password" name="data" placeholder="Repeat Password" />
          <!-- referral code -->
          <input type="text" name="data" placeholder="Referral Code" />
          <button type="submit">Register</button>
        </form>
        <p class="result" id="publishResult"></p>
      </div>
      <div class="forms" id="verification">
        <h2>Verify OTP Code</h2>
        <form id="verifyOTPForm">
          <input id="otpCode" type="text" name="data" placeholder="OTP Code" />
          <button id="otpSubmit" type="submit">Verify</button>
        </form>
        <p class="result" id="verifyOTPResult"></p>
      </div>
      <div class="forms" id="login">
        <h2>Login</h2>
        <form id="loginForm">
          <input id="loginEmail" type="text" name="data" placeholder="Email" />
          <input
            id="loginPwd"
            type="password"
            name="data"
            placeholder="Password"
          />
          <button type="submit">Login</button>
        </form>
        <p class="result" id="verifyResult"></p>
      </div>
      <!-- logout -->
      <div id="logout">
        <button id="logoutButton">Logout</button>
      </div>
      <!-- copyright 2024 NotaryHash and SmartLedger -->
      <p>&copy; 2024 NotaryHash and SmartLedger. All rights reserved.</p>
    </div>
    <script src="encryption.js"></script>
    <script>
      let password = "";
      const Buffer = bsv.deps.Buffer;
      const generateKeys = () => {
        const Mnemonic = bsv.Mnemonic;
        const mnemonic = new Mnemonic();
        const fullPath = "m/44'/0'/0'/0/0";
        const xpriv = mnemonic.toHDPrivateKey(); // HD Private Key
        const derivedPriv = xpriv.deriveChild(fullPath); // Derive the private key using the full path
        const priv = derivedPriv.privateKey; // Get the actual private key
        const pub = bsv.PublicKey.fromPrivateKey(priv); // Derive the public key from the private key
        address = bsv.Address.fromPublicKey(pub).toString();
        const jsonString = JSON.stringify({
          address: address,
          privateKey: priv.toString(),
          publicKey: pub.toString(),
          mnemonic: mnemonic.toString(),
          path: fullPath,
        });
        return jsonString;
      };
      const encrypt = (myString, myPassword) => {
        //crypto-js
        const cryptoJS = window.CryptoJS;
        // Encrypt
        const ciphertext = cryptoJS.AES.encrypt(
          myString,
          myPassword
        ).toString();
        return ciphertext;
      };
      //
      const decrypt = (myString, myPassword) => {
        //crypto-js
        const cryptoJS = window.CryptoJS;
        // Decrypt
        const bytes = cryptoJS.AES.decrypt(myString, myPassword);
        const plaintext = bytes.toString(cryptoJS.enc.Utf8);
        return plaintext;
      };

      const hashData = (data) => {
        // Return the hash as a Buffer
        return bsv.crypto.Hash.sha256(Buffer.from(data));
      };

      const signData = (data) => {
        const privateKey = bsv.PrivateKey.fromWIF(
          localStorage.getItem("privateKey")
        );

        // Use the hash buffer directly
        const hashBuffer = hashData(data);
        const signature = bsv.crypto.ECDSA.sign(hashBuffer, privateKey);

        return signature.toString();
      };
      const verifyData = (data, sig, address) => {
        const publicKey = new bsv.PublicKey(address);
        const signature = new bsv.crypto.Signature(sig);
        return bsv.crypto.ECDSA.verify(
          Buffer.from(hashData(data)),
          signature,
          publicKey
        );
      };
      //if not keys in local storage, create them
      if (!localStorage.getItem("privateKey")) {
        const jsonString = generateKeys();
        const keys = JSON.parse(jsonString);
        const privateKey = bsv.PrivateKey.fromWIF(keys.privateKey);
        const publicKey = bsv.PublicKey.fromPrivateKey(privateKey);
        const address = bsv.Address.fromPublicKey(publicKey).toString();
        const mnemonic = keys.mnemonic;
        const path = keys.path;
        localStorage.setItem("keys", jsonString);
        localStorage.setItem("privateKey", privateKey);
        localStorage.setItem("publicKey", publicKey);
        localStorage.setItem("address", address);
        localStorage.setItem("mnemonic", mnemonic);
        localStorage.setItem("path", path);
      }
      document
        .getElementById("publishForm")
        .addEventListener("submit", function (e) {
          e.preventDefault();
          const firstName = document.getElementsByName("data")[0].value;
          const lastName = document.getElementsByName("data")[1].value;
          const birthdate = document.getElementsByName("data")[2].value;
          const country = document.getElementsByName("data")[3].value;
          let referralCode = document.getElementsByName("data")[6].value;
          const email = document.getElementById("emailRegister").value;
          password = document.getElementsByName("data")[4].value;
          const repeatPassword = document.getElementsByName("data")[5].value;
          console.log(
            firstName,
            lastName,
            birthdate,
            country,
            email,
            password,
            repeatPassword
          );
          if (password !== repeatPassword) {
            alert("Passwords do not match");
            return;
          }
          if (
            !firstName ||
            !lastName ||
            !birthdate ||
            !country ||
            !password ||
            !repeatPassword ||
            !email
          ) {
            alert("Please fill in all fields");
            return;
          }
          const passwordHash = bsv.crypto.Hash.sha256(
            Buffer.from(password)
          ).toString("hex");

          const doubleHash = bsv.crypto.Hash.sha256(
            Buffer.from(passwordHash)
          ).toString("hex");
          const data = `${firstName}${lastName}${birthdate}${country}`;
          const encryptedKeys = encrypt(localStorage.getItem("keys"), password);
          const encryptedData = encrypt(data.toLowerCase(), password);
          const hash = hashData(data.toLowerCase());
          const signature = signData(data.toLowerCase());
          localStorage.setItem(
            "identity",
            JSON.stringify({
              data: data.toLowerCase(),
              encryptedData: encryptedData,
              encryptedKeys: encryptedKeys,
              firstName: firstName.toLowerCase(),
              lastName: lastName.toLowerCase(),
              birthdate: birthdate,
              country: country.toLowerCase(),
              email: email.toLowerCase(),
              password: doubleHash,
              hash: hash.toString("hex"),
              signature: signature,
              publicKey: localStorage.getItem("publicKey"),
              address: localStorage.getItem("address"),
            })
          );
          sendData(
            "/registerId",
            {
              data: data,
              encryptedData: encryptedData,
              encryptedKeys: encryptedKeys,
              firstName: firstName,
              lastName: lastName,
              birthdate: birthdate,
              country: country,
              email: email,
              referralCode: referralCode,
              passwordHash: doubleHash,
              hash: hash.toString("hex"),
              signature: signature,
              publicKey: localStorage.getItem("publicKey"),
              address: localStorage.getItem("address"),
            },
            "publishResult",
            true,
            "register"
          );
        });

      // login
      document
        .getElementById("loginForm")
        .addEventListener("submit", function (e) {
          e.preventDefault();
          const email = document.getElementById("loginEmail").value;
          password = document.getElementById("loginPwd").value;
          const passwordHash = bsv.crypto.Hash.sha256(
            Buffer.from(password)
          ).toString("hex");
          const doubleHash = bsv.crypto.Hash.sha256(
            Buffer.from(passwordHash)
          ).toString("hex");
          sendData(
            "/login",
            {
              passwordHash: doubleHash,
              email: email,
            },
            "verifyResult",
            true,
            "login"
          );
        });

      // verify OTP
      document
        .getElementById("verifyOTPForm")
        .addEventListener("submit", function (e) {
          e.preventDefault();
          const otpCode = document.getElementById("otpCode").value;
          sendData(
            "/otpVerify",
            {
              otpCode: otpCode,
            },
            "verifyOTPResult",
            true,
            "verifyOTP"
          );
        });
      function sendData(url, data, resultElementId, txStatus, registerStatus) {
        fetch(url, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(data),
        })
          .then((response) => response.text())
          .then((data) => {
            console.log("Success:", data);
            const json = JSON.parse(data);
            const txid = json.txid;
            const message = json.message;
            document.getElementById("resultTxid").innerHTML = txStatus
              ? `<a href="https://whatsonchain.com/tx/${txid}" target="_blank">${txid}</a>`
              : "";
            document.getElementById("resultTxid").style.display = "block";
            document.getElementById("message").innerHTML = message;
            document.getElementById("message").style.display = "block";
            document.getElementById("logout").style.display = "block";
            if (registerStatus == "register") {
              localStorage.setItem("registered", true);
              document.getElementById("login").style.display = "none";
              document.getElementById("registration").style.display = "none";
              document.getElementById("verification").style.display = "block";
              document.getElementById("buttonChoices").style.display = "none";
            } else if (registerStatus == "login") {
              localStorage.setItem("loggedIn", true);
              document.getElementById("login").style.display = "none";
              document.getElementById("registration").style.display = "none";
              document.getElementById("verification").style.display = "block";
              document.getElementById("buttonChoices").style.display = "none";
            } else if (registerStatus == "verifyOTP") {
              localStorage.setItem("verifiedOTP", true);
              localStorage.setItem("token", json.token);
              localStorage.setItem("date", json.date);
              const member = json.member;
              const token = json.token;
              const date = json.date;
              const encryptedKeys = member.encryptedKeys;
              console.log(encryptedKeys, member, token, date);
              const keys = decrypt(encryptedKeys, password);
              //store keys in local storage
              const { privateKey, publicKey, address, mnemonic, path } =
                JSON.parse(keys);
              localStorage.setItem("registered", true);
              localStorage.setItem("path", path);
              localStorage.setItem("privateKey", privateKey);
              localStorage.setItem("publicKey", publicKey);
              localStorage.setItem("address", address);
              localStorage.setItem("mnemonic", mnemonic);
              localStorage.setItem("member", JSON.stringify(member));
              localStorage.setItem("keys", keys);
              location.href = "/dashboard";
            }
          })
          .catch((error) => {
            console.error("Error:", error);
          });
      }
      const getUtxos = (address) => {
        return fetch(
          `https://api.whatsonchain.com/v1/bsv/main/address/${address}/unspent`
        )
          .then((response) => response.json())
          .then((data) => {
            return data.map((utxo) => {
              return {
                txId: utxo.tx_hash,
                outputIndex: utxo.tx_pos,
                satoshis: utxo.value,
                script: bsv.Script.buildPublicKeyHashOut(address).toHex(),
              };
            });
          });
      };

      const broadcastTx = (tx) => {
        return fetch("https://api.whatsonchain.com/v1/bsv/main/tx/raw", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ txhex: tx.toString() }),
        })
          .then((response) => response.json())
          .then((data) => {
            return data;
          });
      };

      const sendFunds = async (receiver, amount) => {
        const address = localStorage.getItem("address");
        const utxos = await getUtxos(address);
        const privateKey = bsv.PrivateKey.fromWIF(
          localStorage.getItem("privateKey")
        );
        const tx = new bsv.Transaction()
          .from(utxos)
          .to(receiver, amount)
          .change(address)
          .sign(privateKey);
        console.log(tx.toString());
        document.getElementById(
          "publishResult"
        ).innerHTML = `<a href="https://whatsonchain.com/tx/${tx.id}" target="_blank">${tx.id}</a>`;
        document.getElementById("publishResult").style.display = "block";
        const txId = await broadcastTx(tx);
        console.log(txId);
      };

      //clear all inputs
      const clearInputs = () => {
        const inputs = document.getElementsByTagName("input");
        for (let i = 0; i < inputs.length; i++) {
          inputs[i].value = "";
        }
      };
      document
        .getElementById("showRegistration")
        .addEventListener("click", () => {
          document.getElementById("registration").style.display = "block";
          document.getElementById("verification").style.display = "none";
          document.getElementById("login").style.display = "none";
          clearInputs();
          document.getElementsByName("data")[0].focus();
          document.getElementsByName("data")[0].scrollIntoView();
        });
      document.getElementById("showLogin").addEventListener("click", () => {
        document.getElementById("registration").style.display = "none";
        document.getElementById("verification").style.display = "none";
        document.getElementById("login").style.display = "block";
        clearInputs();
        //focus on email input
        document.getElementById("login").scrollIntoView();
        document.getElementById("loginEmail").focus();
      });
      document.getElementById("logoutButton").addEventListener("click", () => {
        localStorage.clear();
        location.href = "/";
      });
    </script>
  </body>
</html>
