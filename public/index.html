<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Blockchain Data Manager</title>
    <!-- bsv@1.5 cdn unpkg -->
    <script src="https://unpkg.com/bsv@1.5"></script>
  </head>
  <style>
    body {
      font-family: "Roboto", sans-serif;
      background-color: #f4f4f4;
      color: #333;
      line-height: 1.6;
      margin: 0;
      padding: 0;
    }
    .mainContainer {
      max-width: 800px;
      margin: 20px auto;
      padding: 20px;
      background: white;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    }
    h1,
    h2,
    a {
      color: #2bd8de; /* Primary color for headers and links */
    }
    h1 {
      text-align: center;
      text-shadow: 0 1px 0 #333;
    }
    h2 {
      margin-top: 40px;
      text-shadow: 0 1px 0 #333;
    }
    form {
      display: flex;
      flex-direction: column;
      margin-bottom: 20px;
    }
    input,
    button {
      padding: 10px;
      margin-bottom: 10px;
      border-radius: 5px;
      border: 1px solid #ddd;
    }
    button {
      background-color: #2bd8de; /* Primary color for buttons */
      color: white;
      border: none;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    button:hover {
      background-color: #29c2c9; /* Slightly darker shade for hover effect */
    }
    p {
      background-color: #e9ecef;
      padding: 10px;
      border-radius: 5px;
    }
    .result {
      word-break: break-all;
      display: none;
    }
  </style>
  <body>
    <div class="mainContainer">
      <h1>NotaryHash Lite</h1>
      <h2>Publish Data</h2>
      <form id="publishForm">
        <input type="text" name="data" placeholder="Enter data to publish" />
        <button type="submit">Publish</button>
      </form>
      <p class="result" id="publishResult"></p>

      <!-- publish pdf file -->
      <h2>Publish PDF File</h2>
      <form id="publishFileForm">
        <input type="file" name="file" placeholder="Enter data to publish" />
        <button type="submit">Publish</button>
      </form>
      <p class="result" id="publishResult"></p>

      <!-- Form for Hashing Data -->
      <h2>Hash Data</h2>
      <form id="hashForm">
        <input type="text" name="data" placeholder="Enter data to hash" />
        <button type="submit">Hash</button>
      </form>
      <p class="result" id="hashResult"></p>

      <!-- Form for Signing Data -->
      <h2>Sign Data</h2>
      <form id="signForm">
        <input type="text" name="data" placeholder="Enter data to sign" />
        <button type="submit">Sign</button>
      </form>
      <p class="result" id="signResult"></p>

      <!-- Form for Verifying Data -->
      <h2>Verify Data</h2>
      <form id="verifyForm">
        <input type="text" name="data" placeholder="Enter data" />
        <input type="text" name="sig" placeholder="Enter signature" />
        <input type="text" name="address" placeholder="Enter address" />
        <button type="submit">Verify</button>
      </form>
      <p class="result" id="verifyResult"></p>
    </div>
    <script>
      const Buffer = bsv.deps.Buffer;
      const hashData = (data) => {
        // Return the hash as a Buffer
        return bsv.crypto.Hash.sha256(Buffer.from(data));
      };

      const signData = (data) => {
        const privateKey = bsv.PrivateKey.fromWIF(
          localStorage.getItem("privateKey")
        );

        // Use the hash buffer directly
        const hashBuffer = hashData(data);
        const signature = bsv.crypto.ECDSA.sign(hashBuffer, privateKey);

        return signature.toString();
      };
      const verifyData = (data, sig, address) => {
        const publicKey = new bsv.PublicKey(address);
        const signature = new bsv.crypto.Signature(sig);
        return bsv.crypto.ECDSA.verify(
          Buffer.from(hashData(data)),
          signature,
          publicKey
        );
      };
      //if not keys in local storage, create them
      if (!localStorage.getItem("privateKey")) {
        const privateKey = new bsv.PrivateKey();
        localStorage.setItem("privateKey", privateKey.toString());
        localStorage.setItem("publicKey", privateKey.toPublicKey().toString());
        localStorage.setItem("address", privateKey.toAddress().toString());
      }
      document
        .getElementById("publishForm")
        .addEventListener("submit", function (e) {
          e.preventDefault();
          const hash = hashData(this.data.value);
          const signature = signData(this.data.value);
          console.log(hash.toString("hex"));
          console.log(signature);
          sendData(
            "/publish",
            {
              data: this.data.value,
              hash: hash,
              signature: signature,
              publicKey: localStorage.getItem("publicKey"),
              address: localStorage.getItem("address"),
            },
            "publishResult",
            true
          );
        });

      document
        .getElementById("hashForm")
        .addEventListener("submit", function (e) {
          e.preventDefault();
          sendData("/hash", { data: this.data.value }, "hashResult");
        });

      document
        .getElementById("signForm")
        .addEventListener("submit", function (e) {
          e.preventDefault();
          sendData("/sign", { data: this.data.value }, "signResult");
        });

      document
        .getElementById("verifyForm")
        .addEventListener("submit", function (e) {
          e.preventDefault();
          sendData(
            "/verify",
            {
              data: this.data.value,
              sig: this.sig.value,
              address: this.address.value,
            },
            "verifyResult"
          );
        });

      document
        .getElementById("publishFileForm")
        .addEventListener("submit", function (e) {
          e.preventDefault();
          const file = this.file.files[0];
          const mimeType = file.type;
          const reader = new FileReader();
          reader.readAsArrayBuffer(file);
          reader.onload = () => {
            const hash = hashData(reader.result);
            const signature = signData(reader.result);
            console.log(hash.toString("hex"));
            console.log(signature);
            sendData(
              "/publishFile",
              {
                data: reader.result,
                mimeType: mimeType,
                hash: hash,
                signature: signature,
                publicKey: localStorage.getItem("publicKey"),
                address: localStorage.getItem("address"),
              },
              "publishResult",
              true
            );
          };
        });

      function sendData(url, data, resultElementId, txStatus) {
        fetch(url, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(data),
        })
          .then((response) => response.text())
          .then((data) => {
            document.getElementById(resultElementId).innerHTML = txStatus
              ? `<a href="https://whatsonchain.com/tx/${data}" target="_blank">${data}</a>`
              : data;
            document.getElementById(resultElementId).style.display = "block";
          })
          .catch((error) => {
            console.error("Error:", error);
          });
      }
    </script>
  </body>
</html>
